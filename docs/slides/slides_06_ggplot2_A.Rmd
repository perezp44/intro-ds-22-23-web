---
title: "Gr√°ficos con ggplot2 (A): Primeras ideas"
subtitle: "Programaci√≥n y manejo de datos con R (Slides 06-A)"  
author: 
  - "Pedro J. P√©rez"
  #- "2020, septiembre"
date: "(actualizadas en `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    self_contained: true
    seal: false   #- puedes tunear la primera p√°gina de las slides    
    lib_dir: libs
    css: 
      - ../assets/xaringan-themer.css
      - ../assets/my_css_file_verdes_solo_ggplot.css
      #- ../assets/my_css_file_xaringan_verdes.css  #- good (funciona lo de justify)
    nature:
      highlightStyle: github  #- solarized-light ; googlecode
      highlightLines: true
      highlightLanguage: ["r"]
      countIncrementalSlides: false
      #ratio: "16:9"
    includes:
      #after_body: [css/insert-logo.html]
      in_header: 
        - !expr here::here("assets", "favicon-yo.html") 
        #- !expr here::here("assets", "google-analytics.html") 
#      in_header: ["favicon-yo.html", "google-analytics.html"]
---


```{r xaringan-extra, include = FALSE}
xaringanExtra::use_xaringan_extra(c("tile_view", "logo", "tachyons", "animate_css", "scribble"))
#xaringanExtra::use_share_again()
xaringanExtra::use_clipboard()
xaringanExtra::use_fit_screen()
xaringanExtra::use_tile_view()
xaringanExtra::use_tachyons()
xaringanExtra::use_extra_styles(hover_code_line = TRUE, mute_unhighlighted_code = FALSE)
xaringanExtra::use_panelset()
```

```{r xaringan-themer, include = FALSE, warning = FALSE}
library(xaringanthemer)
style_mono_light(
  base_color = "#1c5253", 
  colors = c(red = "#f34213", purple = "#3e2f5b", orange = "#ff8811", 
             green = "#136f63", white = "#FFFFFF", base = "#1c5253",
             gray = "#708090", salmon = "#ff8c69", indianred = "#cd5c5c"),
  link_color = "steelblue",
  #header_font_google = google_font("Josefin Sans"),  #- https://fonts.google.com/
  #text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono"))
```

```{r chunk-setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE,
                      #results = "hold",
                      cache = FALSE, cache.path = "/caches/", comment = "#>",
                      #fig.width = 7, #fig.height= 7,
                      #out.width = 7, out.height = 7,
                      collapse = TRUE,  fig.show = "hold", fig.retina = 4,
                      fig.asp = 7/9, out.width = "95%", fig.align = "center")
options(scipen = 999) #- para quitar la notaci√≥n cient√≠fica
#- para mejorar los gr√°ficos, bueno en realidad para que se vean igual en distintos SO
#- https://www.jumpingrivers.com/blog/r-knitr-markdown-png-pdf-graphics/
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
#options(htmltools.dir.version = FALSE) #- lo pongo en setup
#xaringan::inf_mr() 
```

```{r, include = FALSE}
library(flipbookr)
library(tidyverse)
```

```{css, include = FALSE}
.remark-code{line-height: 1.5; font-size: 80%}
@media print {
  .has-continuation {
    display: block;
  }
```


class: inverse, center, middle

<br>

#### `r rmarkdown::metadata$subtitle`

## `r rmarkdown::metadata$title`

<br>

### `r rmarkdown::metadata$author`

#### 2020, septiembre

###### (actualizadas el `r format(Sys.time(), '%d-%m-%Y')`)


<br><br>
  
#### e-mail: [pedro.j.perez@uv.es](mailto:pedro.j.perez@uv.es)
  
#### Web del curso: [https://perezp44.github.io/intro-ds-20-21-web](https://perezp44.github.io/intro-ds-21-22-web)

```{r echo = FALSE}
xaringanExtra::style_share_again(share_buttons = c("twitter", "linkedin", "pocket") )
```

---
class: inverse, center, middle
background-image: url(imagenes/ss_06_img_01_ggplot2-hex.png)
background-position: 95% 5%
background-size: 10%

## Gr√°ficos chulos con *ggplot2*

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

#### Uno de los mejores (que dices!?, el MEJOR!!!) sistema gr√°fico del MUNDO.

---
background-image: url(imagenes/ss_06_img_01_ggplot2-hex.png)
background-position: 98% 2%
background-size: 5%

##### el an√°lisis gr√°fico es fundamental

- El **an√°lisis gr√°fico es fundamental** al presentar resultados, pero tambi√©n en el an√°lisis exploratorio: permite descubrir relaciones entre variables, y descartar o sugerir nuevas preguntas sobre los datos.


```{r, echo = FALSE, out.width = "75%", fig.align = "center"}
knitr::include_graphics(here::here("imagenes", "tt_06_img_01_explore-visualice.png"))
```

--

--------------------------------------

- R tiene varios sistemas gr√°ficos, pero **usaremos ggplot2**

- *ggplot2* es un paquete de R para producir gr√°ficos estad√≠sticos. Bueno, en realidad **es todo un ecosistema**. Mira sus extensiones [[aqu√≠]](https://exts.ggplot2.tidyverse.org/gallery/).

- Es diferente porque tiene una **gram√°tica subyacente**, basada en Grammar of Graphics (Wilkinson 2005).

- Cuesta un poco (s√≥lo un poco) m√°s empezar, pero enseguida se ven los beneficios; adem√°s, es que **ahora mismo es el est√°ndar**. 

---
class: inverse, center, middle
background-image: url(imagenes/ss_06_img_01_ggplot2-hex.png)
background-position: 95% 5%
background-size: 10%

## Primeras ideas sobre *ggplot2*

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

#### Primeras ideas para empezar a familiarizarnos con *ggplot2*

---
background-image: url(imagenes/ss_06_img_01_ggplot2-hex.png)
background-position: 98% 2%
background-size: 5%

##### ¬øqu√© vemos en el gr√°fico de abajo?


.pull-left[
```{r, echo = FALSE, out.width = "90%", fig.retina = 4, fig.asp = 6.9/9}
ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + geom_point()
```
]

--

.pull-right[

<br>

- gr√°fico de puntos  

- se representan 3 variables

- Sepal.Length en el **eje X** 

- Petal.Length en el **eje Y**

- Species en el **color de los puntos**
]

--

##### Importante para entender ggplot2 [ üåü ]

 Un gr√°fico tiene 3 componentes principales:
  
  - los **datos** que se van a representar  (.orange[ggplot()] )

  - un conjunto de **propiedades est√©ticas asociadas variables** del conjunto de datos. Por ejemplo, la posici√≥n en el eje X esta asociada a la variable Sepal.Length, el color de los puntos est√° asociado a los valores de la variable Species.  (  .orange[aes()] )

  - el **elemento geom√©trico que se va a representar**. En nuestro caso el elemento geom√©trico que usamos son  puntos ( .orange[geom_point()] ), pero podr√≠an haber sido las lineas ( .orange[geom_line()] ) o ...  (  .grey[geom_xx()] )

---

##### sintaxis de ggplot2 [ üåü ]

```{r, echo = TRUE, out.width = "40%", fig.retina = 4}
ggplot(iris, aes(x = Sepal.Length, 
                 y = Petal.Length, 
                 color = Species)) + 
    geom_point()
```

--
##### Forma m√°s compacta de escribirlo

```{r, eval = FALSE}
ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + 
    geom_point()
```


---

```{r grafico-00, include = FALSE, fig.retina = 4}
iris %>% 
ggplot() + 
   aes(x = Sepal.Length) +
   aes(y = Petal.Length) +
   aes(color = Species)  + 
  geom_point()
```

`r chunk_reveal(chunk_name = "grafico-00", title = "##### Gr√°fico en slow-motion!")`

--

<br>

##### La forma habitual(!) de escribirlo es:

```{r, eval = FALSE}
ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + 
    geom_point()
```

---
##### IMAGINA que har√°n las siguientes instrucciones. Despu√©s las ejecutas.


```{r, eval = FALSE}
#- F√≠jate: `s√≥lo` hay `2 variables en aes()` -------------------------------------

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
  geom_point()

#- F√≠jate: ahora usamos `geom_line()` ------------------------------------------

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
  geom_line() 

#- F√≠jate: Ahora usamos `2 geom_xx`---------------------------------------------
ggplot(iris, aes(Sepal.Length, Petal.Length)) + geom_point() +  
      geom_smooth() 


#- F√≠jate: volvemos a tener 3 variables asociadas a est√©ticas ----------------

ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + 
  geom_point()

#- F√≠jate**: hay `argumentos dentro de geom_point()`---------------------------- 
#- Uno de ellos es `color`

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
      geom_point(color = "red", size = 2, alpha = 0.2) 
```


---
class: inverse, center, middle
background-image: url(imagenes/ss_06_img_01_ggplot2-hex.png)
background-position: 95% 5%
background-size: 10%

### Entendiendo un poco m√°s *ggplot2*

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

#### Ya tenemos las primeras ideas sobre ggplot2, ahora se trata de profundizar un poco para que podamos tener m√°s control y flexibilidad al hacer nuestros gr√°ficos.



---
#####  vamos a profundizar un poco m√°s en *ggplot2*

Es importante que veas que estas 3 expresiones **hacen el mismo gr√°fico**:

```{r, echo = TRUE, eval = FALSE}
ggplot(iris, aes(Sepal.Length, Petal.Length)) + geom_point()

ggplot(iris) + geom_point(aes(Sepal.Length, Petal.Length))

ggplot() + geom_point(data = iris, aes(Sepal.Length, Petal.Length))
```

.purple[`r icons::fontawesome("check-circle")`]  Si utilizas la *tercera expresi√≥n*; es decir, si especificas los datos dentro de geom_xx(), es necesario poner el nombre del argumento: (.red[data = iris] , ...) [ üåü ]

--

```{r, echo = FALSE, eval = TRUE,  out.width = "66%", fig.asp = 3/5, fig.retina = 4}
ggplot(iris, aes(Sepal.Length, Petal.Length)) + geom_point()
```

---

##### repito esto porque es IMPORTANTE .... [ üåü ]


- Podemos especificar los **mappings** de variables en est√©ticas dentro de cada *geom_xx()* 

```{r, eval = FALSE}
ggplot(iris) + geom_point(aes(Sepal.Length, Petal.Length))
```

--
<br>

- Podemos especificar los **datos** dentro de cada *geom_xx()* . En este caso no te olvides de poner (.red[data = ...])

```{r, eval = FALSE}
ggplot() + geom_point(data = iris, aes(Sepal.Length, Petal.Length))
```

--

<br>

---------------------

- Bueno, s√≠ ¬øY que m√°s da? Pues importa y muuuuccho. 

- Esto **nos va a dar mucha flexibilidad**/control a nuestros gr√°ficos. Lo vemos


---
##### ¬øqu√© hacen estas 3 expresiones?

```{r, eval = FALSE}
ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + 
     geom_point() + geom_smooth()

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
    geom_point(aes(color = Species)) + geom_smooth()

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
    geom_point() + geom_smooth(aes(color = Species))
```

--

```{r, echo = FALSE}
p1a <- ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) +
    geom_point() + geom_smooth() +
    ggtitle('Plot 1') + theme(legend.position = "none") + xlab(NULL) + ylab(NULL) + theme(plot.title = element_text(size=6), axis.text=element_text(size = 5))

p2a <- ggplot(iris, aes(Sepal.Length, Petal.Length)) +
    geom_point(aes(color = Species)) + geom_smooth() +
    ggtitle('Plot 2') + theme(legend.position = "none") + xlab(NULL) + ylab(NULL) + theme(plot.title = element_text(size=6), axis.text=element_text(size = 5))

p3a <- ggplot(iris, aes(Sepal.Length, Petal.Length)) +
    geom_point() + geom_smooth(aes(color = Species)) +
    ggtitle('Plot 3') + theme(legend.position = "none") + xlab(NULL) + ylab(NULL) + theme(plot.title = element_text(size=6), axis.text=element_text(size = 5))
```


```{r, echo = FALSE, eval = TRUE,  out.width = "100%", fig.asp = 2.4/5, fig.retina = 4}
library(patchwork)
p1a + p2a + p3a + plot_layout(nrow = 2, byrow = TRUE)
```

---

##### ejemplos: ¬øpor qu√© no funcionan 3 de estas 4 expresiones?


```{r, eval = TRUE, error = TRUE,  out.width = "55%", fig.asp = 2.4/5, fig.retina = 4}
ggplot(iris) + geom_point(aes(Sepal.Length, Petal.Length)) + 
    geom_smooth(aes(color = Species))

ggplot() + geom_point(data = iris, aes(Sepal.Length, Petal.Length)) + 
    geom_line(aes(Sepal.Length, Petal.Length))

ggplot(aes(Sepal.Length, Petal.Length)) + geom_point(data = iris) + 
    geom_line()

ggplot() + geom_point(data = iris, aes(Sepal.Length, Petal.Length)) + 
    geom_line()
```

---
##### Un ejemplo un poco marciano

```{r, eval = FALSE}
iris2 <- iris %>% filter(Species != "setosa") #- lirios que no son "setosa"

ggplot() + 
geom_point(data = iris, aes(Sepal.Length, Petal.Length, color = Species)) +
   geom_smooth(data = iris2, aes(Sepal.Length, Petal.Length) ) 

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
  geom_point(aes(color = Species)) + geom_smooth(data = iris2)
```

--

```{r, echo = FALSE, out.width = "70%", fig.asp = 3/5, fig.retina = 4}
iris2 <- iris %>% filter(Species != "setosa") #- lirios que no son "setosa"

ggplot(iris, aes(Sepal.Length, Petal.Length)) + geom_point(aes(color = Species)) + geom_smooth(data = iris2)
```

---
##### otro ejemplo/tarea m√°s: 


.panelset[
.panel[.panel-name[Tarea]

Quiero que las 2 especies de lirios grandes se representen con el mismo color, ¬øc√≥mo lo hago?

Hay varias soluciones, una de las m√°s marcianas es la Soluci√≥n 1.
]
.panel[.panel-name[Soluci√≥n 1]

```{r, eval = TRUE, out.width = "70%", fig.asp = 3/5, fig.retina = 4}
iris_setosa <- iris %>% filter(Species == "setosa") #- me quedo con los lirios peque√±os, los de clase "setosa"

ggplot(iris, aes(Sepal.Length, Petal.Length)) + geom_point() + 
    geom_point(data = iris_setosa, aes(color = Species)) + 
    geom_smooth(data = iris2, aes(Sepal.Length, Petal.Length) )
```
]
.panel[.panel-name[Soluci√≥n 2]
```{r, eval = TRUE, out.width = "70%", fig.asp = 3/5, fig.retina = 4}
iris_solo_2_clases <- iris %>% 
  mutate(Species_2 = ifelse(Species %in% c("versicolor", "virginica"), "versi_virgi", "setosa"))

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
  geom_point() + 
  geom_point(data = iris_setosa, aes(color = Species)) +
  geom_smooth(data = iris_solo_2_clases,aes(Sepal.Length, Petal.Length, color = Species_2) )

```

]
.panel[.panel-name[Soluci√≥n 3 (good)]
```{r, eval = TRUE, out.width = "70%", fig.asp = 3/5, fig.retina = 4}
iris_solo_2_clases <- iris %>% 
  mutate(Species_2 = ifelse(Species %in% c("versicolor", "virginica"), "versi_virgi", "setosa"))

ggplot(iris_solo_2_clases, aes(Sepal.Length, Petal.Length, color = Species_2)) + 
  geom_point() + geom_smooth()
```
]
]

---
##### un ejemplo m√°s

- Para ir acabando con la ‚Äúfilosof√≠a‚Äù/sintaxis/gram√°tica de ggplot2 **intenta imaginar** que gr√°ficos hacen las 6 expresiones de m√°s abajo.

- Si no puedes, recuerda que siempre puedes ejecutar las ordenes en el ordenador. F√≠jate sobre todo en la **tercera expresi√≥n**

```{r, eval = FALSE}
ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
  geom_point() + geom_smooth()

ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + 
  geom_point() + geom_smooth()

ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + 
   geom_point(color = "purple") + geom_smooth()

ggplot(iris, aes(Sepal.Length, Petal.Length, color = Species)) + 
  geom_point() + geom_smooth(color = "brown")

ggplot(iris, aes(Sepal.Length, Petal.Length)) + 
  geom_point() + geom_smooth(aes(color = Species))

ggplot(iris) + 
  geom_point(aes(Sepal.Length, Petal.Length, color = Species) ) +
  geom_smooth(aes(Sepal.Length, Petal.Length, color = Species))
```


---

##### veremos alguna vez otros gr√°ficos? 

- S√ç!!!! pero a√∫n falta un poco, hemos de ver m√°s cosas (y s√≠, usando `iris`). 

- Si no puedes eperarte ve a est√° [Graph gallery](https://exts.ggplot2.tidyverse.org/gallery/)

##### *the  aesthetic parameters* de cada geom_xx()

- Cuando empecemos a hacer otros tipos de gr√°ficos ser√° de utilidad conocer que par√°metros tiene cada `geom_xx()`.

- Podremos verlos consultando la ayuda de cada `geom`, pero tambi√©n puedes verlas [aqu√≠](https://www.yihanwu.ca/post/geoms-and-aesthetic-parameters/)

---
class: inverse, center, middle
background-image: url(imagenes/ss_06_img_01_ggplot2-hex.png)
background-position: 95% 5%
background-size: 10%

### M√°s elementos de *ggplot2*

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

###### Como puedes imaginar, a√∫n tenemos que ver m√°s elementos de ggplot2: los t√≠tulos y leyendas, los ejes, el tema, coordenadas, etc‚Ä¶ vamos a ello!!

---
##### m√°s elementos de un ggplot()

- Ya hemos presentado los principales elementos de los gr√°ficos hechos con ggplot2, pero es evidente que **un gr√°fico tiene m√°s elementos**.

- L√≥gicamente, **hay que conocerlos un poco** para poder ajustar los gr√°ficos a nuestras necesidades y mejorar su calidad. 

--

--------------------

Veremos algo de los siguientes elementos:

- T√≠tulos del gr√°fico 
- Themes  
- Small multiples (o Facetting)
- Anotaciones  
- Ejes  
- Escalas  
- Stats (transformaciones estad√≠sticas)  
- Position adjustments  
- Coordenadas  

----------------------------------

 .bg-washed-green.b--dark-green.ba.bw2.br3.shadow-5.ph4.mt5[
    Ser√° en las siguientes slides]
